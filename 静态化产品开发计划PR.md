# NotionNext 网站静态化与国内同步项目计划

## 1. 项目目标

本项目旨在解决基于 NotionNext 搭建、并部署在 Vercel 上的网站在中国大陆地区访问速度慢或受限的问题。通过将网站完全静态化并自动同步至国内服务器，为国内用户提供一个高速、稳定的“镜像”访问站点，同时保留 Notion 作为内容管理系统的便捷性。

## 2. 核心流程

项目的核心是建立一个全自动化的内容发布与同步管道：

```mermaid
flowchart TD
    A[1. 在 Notion 中更新内容] --> B[2. Vercel 自动检测变更并触发构建]
    B --> C[3. Next.js 生成纯静态文件(out/ 目录)]
    C --> D[4. 自动化脚本(如 GitHub Actions)将静态文件同步至国内服务器]
    D --> E[5. 国内用户通过备案域名高速访问站点]
```

## 3. 开发阶段与任务分解

### 阶段一：NotionNext 项目静态化改造 (预计 1 天)

-   [ ] **任务 1.1: 修改 `next.config.js`**
    -   [ ] 添加 `output: 'export'` 以启用静态导出模式。
    -   [ ] 添加 `trailingSlash: true` 以确保 URL 路径兼容性。
    -   [ ] 添加 `images: { unoptimized: true }` 来禁用 Vercel 的图片优化服务，使图片能在任何服务器上正常显示。
-   [ ] **任务 1.2: 修改 Vercel 构建配置**
    -   [ ] 在 Vercel 项目设置中，将 **Output Directory** 指定为 `out`。
-   [ ] **任务 1.3: 本地验证**
    -   [ ] 在本地执行 `npm run build` 命令。
    -   [ ] 检查根目录下是否成功生成了包含所有 HTML, CSS, JS 文件的 `out` 目录。
    -   [ ] 启动一个本地静态服务器（如 `serve out`），验证网站功能是否正常。

### 阶段二：环境准备与基础配置 (预计 1-2 天)

-   [ ] **任务 2.1: 国内服务器与域名**
    -   [ ] 准备一台国内云服务器（如阿里云/腾讯云）。
    -   [ ] 安装并配置 Nginx 作为 Web 服务器。
    -   [ ] 确保拥有一个已备案的域名，并将其解析到服务器 IP。
-   [x] **任务 2.2: 安全与访问配置**
    -   **工作笔记：** 为实现 GitHub Actions 到阿里服务器的自动化、免密部署，我们配置了 SSH 密钥认证。这是保障自动化流程安全、顺畅运行的核心前提。
    -   **实现步骤：**
        1.  **在本地生成密钥对：** 使用 `ssh-keygen -t ed25519 -f ~/.ssh/github_actions` 命令在本地电脑上创建了一对新的、高安全性的 SSH 密钥（公钥 `github_actions.pub` 和私钥 `github_actions`）。这把“钥匙”将专用于本次自动化部署。
        2.  **登录远程服务器：** 通过 `ssh root@服务器IP` 命令，使用 root 密码首次登录到阿里云服务器。
        3.  **安装公钥：** 在服务器上，将本地 `github_actions.pub` 文件的内容（公钥）追加到服务器的 `~/.ssh/authorized_keys` 文件中。这个文件相当于服务器的“授权锁孔登记处”。
        4.  **设置正确权限：** 为了确保 SSH 安全机制生效，使用 `chmod` 命令将 `~/.ssh` 目录的权限设置为 `700`（只有所有者能读写执行），`authorized_keys` 文件的权限设置为 `600`（只有所有者能读写）。
    -   **最终效果：** 完成后，任何持有私钥 `github_actions` 的客户端（未来将是 GitHub Actions）都可以无需密码直接登录服务器，为后续的自动化文件同步（rsync）奠定了基础。

你刚刚生成的公钥和密钥是两个 “文件”还是什么东西？需我要保存以备以后需要吗？它们现在分别在哪里

答：我们刚才生成的是两个真实存在的文件。
私钥（Private Key）：github_actions
公钥（Public Key）：github_actions.pub

我需要保存它们吗？
公钥 (github_actions.pub)：您不需要特意保存。它是一次性用品，我们已经把它安装到服务器上了，它的使命已经完成。
私钥 (github_actions)：非常重要！ 虽然我们马上会把它存到 GitHub 的安全“保险箱”里，但我强烈建议您也自己做一个备份。您可以把它看作是您自动化部署流程的“主钥匙”。万一将来您需要在别的电脑上设置同样的自动化流程，或者需要手动以这个身份登录服务器，您就会需要用到它。
3. 它们现在分别在哪里？
这两个文件现在都存放在您本地电脑的一个隐藏文件夹里。具体路径是：

/Users/appletf/.ssh/

您可以通过以下方式找到它们：

打开您电脑的 "Finder" (访达)。
在顶部的菜单栏选择 "Go" (前往) -> "Go to Folder..." (前往文件夹...)。
在弹出的输入框里，粘贴这个路径 ~/.ssh/ 然后按回车。
您就会看到 github_actions 和 github_actions.pub 这两个文件了。

————————————





### 阶段三：自动化同步流程搭建 (预计 2 天)

-   [ ] **任务 3.1: 选择自动化方案**
    -   [ ] 评估并确定最终方案，**强烈推荐使用 GitHub Actions**，因为它与代码仓库紧密集成，稳定且功能强大。
-   [ ] **任务 3.2: 编写同步工作流 (GitHub Actions)**
    -   [ ] 在项目 `.github/workflows/` 目录下创建 `deploy-to-domestic.yml` 文件。
    -   [ ] 配置 workflow 在代码 `push` 到 `main` 分支后自动触发。
    -   [ ] **Workflow 关键步骤:**
        1.  签出（Checkout）代码。
        2.  安装 Node.js 环境和项目依赖 (`npm install`)。
        3.  执行静态构建 (`npm run build`)。
        4.  使用 `rsync` 命令将 `out/` 目录下的所有文件增量同步到国内服务器的 Web 根目录。
    -   [ ] 将服务器的 SSH 私钥、主机地址、用户名等敏感信息存储为 GitHub Secrets，确保安全。
-   [ ] **任务 3.3: 配置国内服务器 Nginx**
    -   [ ] 为备案域名配置一个 Nginx 虚拟主机（Server Block）。
    -   [ ] 将网站根目录（`root`）指向 `rsync` 同步的目标文件夹。
    -   [ ] 添加 `try_files $uri $uri/ /index.html;` 规则，以支持 Next.js 的前端路由。
    这里方案尝试了多次，请更新笔记

### 阶段四：测试、上线与优化 (预计 1 天)

-   [ ] **任务 4.1: 端到端全流程测试**
    -   [ ] 在 Notion 中发布或修改一篇文章。
    -   [ ] 等待 Vercel 自动部署完成。
    -   [ ] 观察 GitHub Actions 是否被触发并成功执行所有步骤。
    -   [ ] 访问国内域名，验证内容是否已同步更新，所有功能是否正常。
-   [ ] **任务 4.2: 优化与监控 (可选)**
    -   [ ] 在同步脚本中加入 CDN 缓存刷新命令（如果使用了 CDN 服务）。
    -   [ ] 配置工作流状态通知（例如，通过邮件或飞书/钉钉机器人发送成功/失败通知）。
-   [ ] **任务 4.3: 正式上线**
    -   [ ] 确认流程稳定后，正式向用户推广国内访问域名。

## 4. 风险与预案

-   **风险 1**: 静态化后，评论、搜索等动态功能可能失效。
    -   **预案**: 提前评估受影响的功能。对于必要功能，调研并集成第三方静态化友好服务（如 Waline, Algolia Search）。
-   **风险 2**: Notion API 调用达到频率限制，导致 Vercel 构建失败。
    -   **预案**: 优化数据获取逻辑，为 Notion API 数据增加缓存层，减少不必要的重复请求。
-   **风险 3**: 自动化同步脚本因网络波动或权限问题失败。
    -   **预案**: 在 GitHub Actions 中为同步步骤添加重试机制，并配置详细的错误日志与失败告警。

## 5. 验收标准

1.  **自动化**: 在 Notion 中更新内容后，整个流程无需任何人工干预，国内站点内容在 5-10 分钟内自动更新。
2.  **完整性**: 国内站点所有页面、图片、样式和脚本均能正常加载，无 404 错误或资源加载失败问题。
3.  **性能**: 国内站点的核心 Web 指标（如 LCP, FCP）相比直接访问 Vercel 站点有显著提升。
4.  **稳定性**: 自动化流程连续多次测试均能稳定、可靠地运行。