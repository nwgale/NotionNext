# NotionNext项目说明
本项目目前放在github上，用户名nwgale，项目名：NotionNext
这套代码同时会产生两个部署
1）vercel部署(供国外访问)，自动更新，域名blogtianfei.vercel.app/
2）阿里云部署(供国内访问)，手动更新，域名tianfei.chat，在服务器的目录为 /www/wwwroot/tianfei.chat_static

能实现两边同时部署的方法是通过GitHub Actions工作流。当代码推送到GitHub或手动触发工作流时，系统会自动构建静态网站并部署到阿里云服务器。这样，国内用户可以通过tianfei.chat快速访问网站，避开了国外服务器访问慢的问题





# NotionNext 自定义修改说明文档

为了实现作者的个性化要求，作者对NotionNext项目进行了部分自定义修改，以适应自己的需求，特此记录以备以后升级时注意

> 本文档记录了对NotionNext项目的所有自定义修改，用于升级时参考和恢复配置。

## 📋 修改概览

### 1. Notion配置中心数据库字段新增

#### 1.1 页脚链接配置 (5个字段)
- **BEI_AN**: 备案号配置
- **FOOTER_LINK1**: 页脚第一列链接内容
- **FOOTER_LINK2**: 页脚第二列链接内容  
- **FOOTER_LINK3**: 页脚第三列链接内容
- **FOOTER_LINK4**: 页脚第四列链接内容

#### 1.2 教育版页面配置 (3个字段)
- **EDU_HEADER_BACKGROUND_IMG**: 教育版页面头部背景图片URL
- **EDU_TITLE**: 教育版页面标题
- **EDU_DESCRIPTION**: 教育版页面描述

#### 1.3 全局样式配置 (1个字段)
- **GLOBAL_CSS**: 全局CSS样式配置，包含：
  - 背景图片设置
  - 字体配置 (LXGW WenKai)
  - 禁用图片点击放大功能的CSS

### 2. 代码文件修改

#### 2.1 主题文件修改 (simpleFeittt主题)

**新增文件:**
- `themes/simpleFeittt/components/EduHeader.js` - 教育版页面头部组件
- `themes/simpleFeittt/components/EduLayout.js` - 教育版页面布局组件

**修改文件:**
- `themes/simpleFeittt/index.js` - 在LayoutBase中添加PageEdu类型页面的路由拦截
- `themes/simpleFeittt/components/Header.js` - 修改背景色从粉红色改为深灰色

#### 2.2 配置文件修改

**修改文件:**
- `blog.config.js` - 添加教育版相关配置项

### 7. 评论系统配置

- **Cusdis评论系统**: 轻量级开源评论系统，已集成到博客中
- **配置方式**: 通过环境变量配置，同时在Vercel和阿里云部署中生效

## 🔧 详细修改内容

### 1. Notion配置中心字段配置

在Notion配置中心数据库中添加以下字段：

```
字段名: BEI_AN
类型: 文本
用途: 网站备案号显示

字段名: FOOTER_LINK1
类型: 文本  
用途: 页脚第一列链接内容 (Markdown格式)
示例值: #### 关于我(demo)\n\n[个人简介](/about)\n[我的博客](/blog)

字段名: FOOTER_LINK2
类型: 文本
用途: 页脚第二列链接内容 (Markdown格式)
示例值: #### 网站导航(demo)\n\n[网站地图](/sitemap.xml)\n[文章归档](/archive)

字段名: FOOTER_LINK3  
类型: 文本
用途: 页脚第三列链接内容 (Markdown格式)
示例值: #### 精选内容(demo)\n\n[技术教程](/category/tutorial)\n[生活随笔](/category/life)

字段名: FOOTER_LINK4
类型: 文本
用途: 页脚第四列链接内容 (Markdown格式)  
示例值: #### 联系方式(demo)\n\n[电子邮件](mailto:your-email@example.com)\n[GitHub](https://github.com/yourusername)

字段名: EDU_HEADER_BACKGROUND_IMG
类型: 文本
用途: 教育版页面头部背景图片URL
示例值: https://www.notion.so/images/page-cover/nasa_robert_stewart_spacewalk_2.jpg

字段名: EDU_TITLE
类型: 文本
用途: 教育版页面标题
示例值: 田飞教育版主页

字段名: EDU_DESCRIPTION  
类型: 文本
用途: 教育版页面描述
示例值: 这是田飞的主页/教育版

字段名: GLOBAL_CSS
类型: 文本
用途: 全局CSS样式配置
```

### 2. 教育版页面功能实现

#### 2.1 EduHeader.js 组件
**文件路径**: `themes/simpleFeittt/components/EduHeader.js`

**功能**: 
- 教育版页面专用头部组件
- 支持自定义背景图片、标题、描述
- 左上角包含返回首页的小房子图标
- 使用深灰色作为默认背景色

#### 2.2 EduLayout.js 组件  
**文件路径**: `themes/simpleFeittt/components/EduLayout.js`

**功能**:
- 教育版页面专用布局组件
- 完全绕过标准布局，无导航菜单和侧边栏
- 内容宽度限制为max-w-4xl (896px)
- 包含自定义头部、内容区域、页脚和返回顶部按钮

#### 2.3 路由拦截逻辑
**文件路径**: `themes/simpleFeittt/index.js`

**修改内容**:
在LayoutBase组件中添加PageEdu类型页面的拦截逻辑：

```javascript
// 如果是PageEdu类型，直接使用教育版布局，跳过标准布局
if (post?.type === 'PageEdu') {
  return <EduLayout {...props} />
}
```

### 3. 样式修改

#### 3.1 Header背景色修改
**文件路径**: `themes/simpleFeittt/components/Header.js`

**修改内容**: 将背景色从粉红色改为深灰色
- `bg-pink-200` → `bg-gray-700`  
- `dark:bg-pink-900` → `dark:bg-gray-800`

#### 3.2 全局CSS配置
通过GLOBAL_CSS字段配置的样式：

```css
/* 背景图片配置 */
#wrapper {
  background-image: url(...);
  background-position: center;
  background-repeat: no-repeat;
  background-size: 100% 100%;
}

/* 字体配置 */
[id^="theme-"] {
  font-family: LXGW WenKai;
}

/* 禁用图片点击放大功能 */
.medium-zoom-image {
  pointer-events: none !important;
  cursor: default !important;
}

.medium-zoom-overlay {
  display: none !important;
}

.medium-zoom-image--opened {
  display: none !important;
}
```

### 4. 配置文件修改

#### 4.1 blog.config.js 新增配置项

```javascript
// 教育版页面配置
EDU_TITLE: process.env.NEXT_PUBLIC_EDU_TITLE || '田飞教育版主页',
EDU_DESCRIPTION: process.env.NEXT_PUBLIC_EDU_DESCRIPTION || '这是田飞的主页/教育版',  
EDU_HEADER_BACKGROUND_IMG: process.env.NEXT_PUBLIC_EDU_HEADER_BACKGROUND_IMG || 'https://www.notion.so/images/page-cover/nasa_robert_stewart_spacewalk_2.jpg'
```

### 5. 教育版页面优化

为了使教育版页面更加灵活和个性化，对`EduHeader.js`组件进行了优化，使其能够直接使用Notion页面自身的标题、摘要和封面图，而不是依赖全局配置。

#### 5.1 修改的文件

**themes/simpleFeittt/components/EduHeader.js**

修改前：
```javascript
// 从配置中心读取教育版特定字段
const eduTitle = siteConfig('EDU_TITLE') || post?.title || 'Education Page'
const eduDescription = siteConfig('EDU_DESCRIPTION') || post?.summary || ''
const eduBackgroundImg = siteConfig('EDU_HEADER_BACKGROUND_IMG') || ''
```

修改后：
```javascript
// 优先使用页面自身的标题和摘要，其次才是配置中心的值
const eduTitle = post?.title || siteConfig('EDU_TITLE') || 'Education Page'
const eduDescription = post?.summary || siteConfig('EDU_DESCRIPTION') || ''
// 使用Notion页面的封面图作为背景图
const eduBackgroundImg = post?.page_cover || post?.pageCover || ''
```

#### 5.2 实现效果

- **标题和描述**：每个PageEdu类型的页面会优先使用自己的标题和摘要，使内容更加灵活
- **背景图**：直接使用Notion页面设置的封面图作为背景，无需额外配置
- **默认值**：如果页面没有设置标题、摘要或封面图，则会使用默认值

#### 5.3 优势

- **更加灵活**：每个教育版页面可以有不同的标题、描述和背景图
- **更加直观**：直接在Notion中编辑页面属性即可改变页面显示效果
- **减少配置项**：不需要在全局配置中设置固定的标题、描述和背景图
- **更符合内容管理逻辑**：标题、描述和背景图应该是内容的一部分，而不是全局配置

### 6. 规范链接(rel="canonical")实现

为了解决在Vercel和阿里云同时部署带来的SEO问题，实现了规范链接功能，明确告知搜索引擎阿里云部署版本是内容的"主版本"。

#### 5.1 修改的文件

**1. blog.config.js**
添加规范链接相关配置：
```javascript
// 规范链接配置
CANONICAL_DOMAIN: process.env.NEXT_PUBLIC_CANONICAL_DOMAIN || 'https://tianfei.chat', // 规范链接的域名
IS_CANONICAL_HOST: process.env.NEXT_PUBLIC_IS_CANONICAL_HOST === 'true' // 是否为规范主机(阿里云)
```

**2. components/SEO.js**
添加规范链接生成逻辑：
```javascript
// 获取规范链接配置
const CANONICAL_DOMAIN = siteConfig('CANONICAL_DOMAIN')
// 处理当前路径，移除查询参数
let canonicalPath = router.asPath
if (canonicalPath.includes('?')) {
  canonicalPath = canonicalPath.split('?')[0]
}
// 构建完整的规范URL
const canonicalUrl = `${CANONICAL_DOMAIN}${canonicalPath}`

// 在<Head>标签内添加
<link rel='canonical' href={canonicalUrl} />
```

**3. .github/workflows/deploy-to-domestic.yml**
添加规范链接相关环境变量：
```yaml
# 规范链接相关环境变量
NEXT_PUBLIC_CANONICAL_DOMAIN: 'https://tianfei.chat'
NEXT_PUBLIC_IS_CANONICAL_HOST: 'true'
```

#### 5.2 Vercel环境变量配置好

在Vercel控制台中添加以下环境变量：
- `NEXT_PUBLIC_CANONICAL_DOMAIN`: `https://tianfei.chat`
- `NEXT_PUBLIC_IS_CANONICAL_HOST`: `false`

#### 5.3 实现效果

- **Vercel部署版本**：页面包含指向阿里云域名的规范链接
  ```html
  <link rel="canonical" href="https://tianfei.chat/当前页面路径">
  ```

- **阿里云部署版本**：页面包含指向自身的规范链接(自引用)
  ```html
  <link rel="canonical" href="https://tianfei.chat/当前页面路径">
  ```

这样配置后，搜索引擎会将阿里云部署版本视为内容的主版本，避免因重复内容导致的SEO权重分散问题。

### 6. GitHub Actions自动部署到阿里云

#### 6.1 工作流配置文件

**文件路径**: `.github/workflows/deploy-to-domestic.yml`
（在NotionNext/.github/）
**功能**:
- 实现代码推送到GitHub后自动构建静态网站并部署到阿里云服务器
- 支持手动触发部署，方便在Notion内容更新后立即同步
- 使用SSH密钥进行安全的远程服务器访问
- 使用rsync工具高效同步文件

**主要配置**:
```yaml
name: Deploy to Domestic Server

on:
  # 代码推送到main分支时触发
  push:
    branches:
      - main
  # 允许手动触发工作流
  workflow_dispatch:
  # 每6小时自动同步一次Notion内容
  schedule:
    - cron: '0 */6 * * *'  # 在每天的0:00, 6:00, 12:00, 18:00 UTC时间运行

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置Node.js环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 安装依赖
      - name: Install dependencies
        run: npm install

      # 构建静态网站
      - name: Build static files
        run: npm run export
        env:
          EXPORT: true
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }}
          NEXT_PUBLIC_THEME: ${{ secrets.NEXT_PUBLIC_THEME || 'simpleFeittt' }}
          NEXT_PUBLIC_LANG: ${{ secrets.NEXT_PUBLIC_LANG || 'zh-CN' }}

      # 确保目标目录存在
      - name: Create target directory on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          script: |
            /bin/mkdir -p ${{ secrets.REMOTE_TARGET_DIR }}

      # 部署文件到服务器
      - name: Deploy to Server with rsync
        uses: burnett01/rsync-deployments@7.1.0
        with:
          switches: -avz --delete --rsync-path="/usr/bin/rsync"
          path: out/
          remote_path: ${{ secrets.REMOTE_TARGET_DIR }}
          remote_host: ${{ secrets.REMOTE_HOST }}
          remote_user: ${{ secrets.REMOTE_USER }}
          remote_key: ${{ secrets.REMOTE_SSH_KEY }}
```

#### 5.2 GitHub Secrets配置

在GitHub仓库中配置了以下密钥，用于安全地存储敏感信息：

- **REMOTE_HOST**: 阿里云服务器IP地址
- **REMOTE_USER**: 服务器用户名（通常为root）
- **REMOTE_SSH_KEY**: SSH私钥，用于无密码访问服务器
- **REMOTE_TARGET_DIR**: 服务器上的目标目录（如/www/wwwroot/tianfei.chat_static）
- **NOTION_PAGE_ID**: Notion页面ID，用于从Notion获取内容

#### 5.3 SSH密钥配置

为了实现GitHub Actions安全访问阿里云服务器，配置了SSH密钥对：

1. 在本地生成SSH密钥对：
   ```bash
   ssh-keygen -t ed25519 -f ~/.ssh/github_actions
   ```

2. 将公钥添加到服务器的authorized_keys文件：
   ```bash
   ssh-copy-id -i ~/.ssh/github_actions.pub root@服务器IP
   ```

3. 将私钥添加到GitHub仓库的Secrets中（REMOTE_SSH_KEY）

#### 5.4 Nginx配置

在阿里云服务器上配置Nginx，将tianfei.chat域名指向静态文件目录：

```nginx
server {
    listen 80;
    server_name tianfei.chat;
    root /www/wwwroot/tianfei.chat_static;
    index index.html;
    
    # 其他Nginx配置...
}
```

## 🚀 升级时注意事项

### 1. 备份重要文件
升级前请备份以下自定义文件：
- `themes/simpleFeittt/components/EduHeader.js`
- `themes/simpleFeittt/components/EduLayout.js`  
- `themes/simpleFeittt/index.js` (注意LayoutBase的修改)
- `themes/simpleFeittt/components/Header.js` (注意背景色修改)
- `blog.config.js` (注意EDU相关配置)
- `.github/workflows/deploy-to-domestic.yml` (GitHub Actions工作流配置)

### 2. Notion配置保留
Notion配置中心的字段配置通常不会因代码升级而丢失，但建议记录当前配置值。

### 3. 升级后恢复步骤
1. 恢复备份的自定义文件
2. 检查blog.config.js中的EDU配置项
3. 验证教育版页面功能是否正常
4. 检查GLOBAL_CSS配置是否生效

### 4. 测试清单
升级后请测试以下功能：
- [ ] 普通页面显示正常
- [ ] PageEdu类型页面显示正常（无导航栏和侧边栏）
- [ ] 教育版页面头部背景图片、标题、描述显示正确
- [ ] 左上角首页图标功能正常
- [ ] 页脚链接显示正确
- [ ] 图片点击放大功能已禁用
- [ ] 全局字体和背景样式正常
- [ ] GitHub Actions工作流能正常触发（手动和自动）
- [ ] 静态网站能成功部署到阿里云服务器
- [ ] 国内域名tianfei.chat能正常访问最新内容

### 5. GitHub Actions使用说明

#### 5.1 手动触发部署
当您在Notion中添加或修改文章后，可以手动触发部署流程：

1. 访问GitHub仓库页面
2. 点击顶部的"Actions"标签
3. 在左侧列表中找到"Deploy to Domestic Server"工作流
4. 点击右侧的"Run workflow"按钮
5. 在下拉菜单中确认"Run workflow"

这将立即启动构建和部署过程，几分钟后您的更改就会出现在tianfei.chat网站上。

#### 5.2 查看部署状态
您可以随时查看部署的状态和日志：

1. 在GitHub仓库的"Actions"页面
2. 点击最近的"Deploy to Domestic Server"工作流运行记录
3. 查看各个步骤的状态和日志输出

绿色对勾表示部署成功，红色叉号表示部署失败。如果部署失败，可以查看详细日志了解原因。

#### 5.3 常见问题排查

如果部署失败，请检查以下几点：

1. **GitHub Secrets是否正确配置**：
   - REMOTE_HOST、REMOTE_USER、REMOTE_SSH_KEY、REMOTE_TARGET_DIR、NOTION_PAGE_ID

2. **SSH连接问题**：
   - 确保SSH密钥正确且服务器允许SSH连接
   - 检查服务器防火墙设置

3. **构建错误**：
   - 查看构建日志，检查是否有依赖项或配置问题

4. **rsync错误**：
   - 确保服务器上已安装rsync
   - 检查目标目录的权限

### 7. Cusdis评论系统集成

为了提供更好的用户互动体验，在博客中集成了Cusdis评论系统。

#### 7.1 配置方法

**1. 环境变量配置**

在项目的`.env.local`文件中添加以下配置：
```
NEXT_PUBLIC_COMMENT_CUSDIS_APP_ID=87827ee2-b949-4049-a820-f6eeba80bd37
NEXT_PUBLIC_COMMENT_CUSDIS_HOST=https://cusdis.com
NEXT_PUBLIC_COMMENT_CUSDIS_SCRIPT_SRC=https://cusdis.com/js/cusdis.es.js
```

**2. GitHub Actions工作流配置**

在`.github/workflows/deploy-to-domestic.yml`中添加相同的环境变量，确保阿里云部署也能使用评论系统：
```yaml
env:
  # 其他环境变量...
  NEXT_PUBLIC_COMMENT_CUSDIS_APP_ID: '87827ee2-b949-4049-a820-f6eeba80bd37'
  NEXT_PUBLIC_COMMENT_CUSDIS_HOST: 'https://cusdis.com'
  NEXT_PUBLIC_COMMENT_CUSDIS_SCRIPT_SRC: 'https://cusdis.com/js/cusdis.es.js'
```

**3. Vercel环境变量配置**

在Vercel项目设置中添加相同的环境变量，确保Vercel部署也能使用评论系统。

#### 7.2 配置特别之处

**重要：Cusdis配置必须在两个地方同时设置**

在NotionNext项目中，Cusdis评论系统的配置有一个特别之处：必须在两个不同的地方进行配置，否则可能导致评论系统无法正常工作。

1. **本地开发环境配置**：
   - 在`.env.local`文件中设置环境变量
   - 这些环境变量会被`conf/comment.config.js`文件读取
   - 如果环境变量不存在，则使用`comment.config.js`中的默认值

2. **GitHub Actions部署环境配置**：
   - 在`.github/workflows/deploy-to-domestic.yml`文件中设置相同的环境变量
   - 这些环境变量会在构建过程中覆盖默认值
   - 如果不在此处设置，即使本地配置正确，部署后的网站也会使用默认值或错误的配置

**配置流程解析**：

NotionNext项目的配置加载有明确的优先级顺序：
1. 首先读取环境变量（如果存在）
2. 其次读取`conf/comment.config.js`中的默认值
3. 最后读取`blog.config.js`文件

在`conf/comment.config.js`文件中，Cusdis的配置是这样定义的：
```javascript
COMMENT_CUSDIS_APP_ID: process.env.NEXT_PUBLIC_COMMENT_CUSDIS_APP_ID || '87827ee2-b949-4049-a820-f6eeba80bd37',
COMMENT_CUSDIS_HOST: process.env.NEXT_PUBLIC_COMMENT_CUSDIS_HOST || 'https://cusdis.com',
COMMENT_CUSDIS_SCRIPT_SRC: process.env.NEXT_PUBLIC_COMMENT_CUSDIS_SCRIPT_SRC || 'https://cusdis.com/js/cusdis.es.js',
```

**为什么需要在两个地方配置**：

这是因为项目有两个不同的运行环境：
- **本地开发环境**：配置从`.env.local`文件读取
- **GitHub Actions部署环境**：配置从工作流文件中读取

在GitHub Actions的构建过程中，`.env.local`文件不会被包含在代码库中（通常会被`.gitignore`忽略），所以必须在工作流文件中明确设置这些环境变量。

**常见问题**：

如果在切换Cusdis配置（例如从自托管服务切换到官方服务）时，只修改了本地`.env.local`文件而没有同时更新GitHub Actions工作流文件，会导致部署后的网站仍然使用旧的配置，出现评论系统加载失败的问题。

#### 7.2 Cusdis后台管理

- **管理地址**: https://cusdis.com/dashboard
- **功能**:
  - 评论审核
  - 邮件通知（已开启）
  - 数据统计
  - 垃圾评论过滤

#### 7.3 优势

- **轻量级**: 不依赖第三方服务，加载速度快
- **简洁**: 界面简洁，不影响网站美观
- **开源**: 完全开源，数据安全可控
- **多语言**: 支持中文界面
- **无广告**: 纯净的评论体验

### 8. Twikoo 评论系统集成

为了测试和对比，项目中新增了 Twikoo 作为备选评论系统，与 Cusdis 并行运行。

#### 8.1 部署方式

- **后端服务**: 自托管于阿里云 ECS 服务器，通过 `systemd` 服务进行管理。
- **前端访问**: 通过 Nginx 反向代理 `https://tianfei.chat/twikoo/` 访问。

#### 8.2 维护文档

**详细的部署、配置、备份和维护流程已记录在独立的维护手册中：`twikoo总结.md`。** 在进行任何与 Twikoo 相关的操作前，请务必参考该文档。

### 9. Notion API 530 错误修复

为了解决 Notion API 返回 `530` 错误导致网站构建失败的问题，根据官方补丁和实际调试，对项目进行了以下修改。

#### 9.1 问题背景

项目在构建过程中，从 Notion 拉取数据时出现 `Request failed with status code 530` 错误，导致 Vercel 和 GitHub Actions 部署失败。官方解决方案是为 Notion API 请求设置一个个性化的 `API_BASE_URL`。

#### 9.2 修改的文件

**1. blog.config.js**

添加 `API_BASE_URL` 配置，使其能够从环境变量中读取个性化域名。

```javascript
// blog.config.js
const BLOG = {
  // ... 其他配置
  API_BASE_URL: process.env.API_BASE_URL || 'https://www.notion.so/api/v3', // API默认请求地址
  // ... 其他配置
}
```

**2. lib/notion/getNotionAPI.js**

这是最关键的修复。修改 `getNotionAPI.js` 文件，确保在初始化 `notion-client` 时，将 `API_BASE_URL` 配置真正传递给构造函数。

修改前：
```javascript
// 未将 apiBaseUrl 传递给 NotionLibrary
notion = new NotionLibrary({
  activeUser: BLOG.NOTION_ACTIVE_USER || null,
  authToken: BLOG.NOTION_TOKEN_V2 || null,
  userTimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
})
```

修改后：
```javascript
// 将 apiBaseUrl 传递给 NotionLibrary
notion = new NotionLibrary({
  apiBaseUrl: BLOG.API_BASE_URL, // <-- 关键修复
  activeUser: BLOG.NOTION_ACTIVE_USER || null,
  authToken: BLOG.NOTION_TOKEN_V2 || null,
  userTimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
})
```

**3. .github/workflows/deploy-to-domestic.yml**

修改 GitHub Actions 工作流，以确保 `API_BASE_URL` 环境变量在构建过程中被正确使用。

- **添加 Secret**: 在 GitHub 仓库的 `Settings > Secrets and variables > Actions` 中，添加名为 `API_BASE_URL` 的 Secret，其值为个性化的 Notion API 域名。

- **修改构建步骤**:
  - 直接使用 `npx` 调用构建命令，绕过 `npm run` 可能导致的环境变量丢失问题。
  - 在 `env` 块中传入 `API_BASE_URL`。

```yaml
# .github/workflows/deploy-to-domestic.yml

# ... (previous steps)

      # 构建静态网站
      - name: Build static files
        run: |
          npx next build
          npx next-sitemap --config next-sitemap.config.js
          node scripts/merge-sitemap.js
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          EXPORT: true
          # ... 其他环境变量

# ... (subsequent steps)
```

#### 9.3 实现效果

通过以上修改，构建过程会使用指定的 `API_BASE_URL` 来请求 Notion API，从而绕过了 `530` 错误，使得网站可以成功构建和部署。

### 10. 构建时 API 请求优化 (解决 429 错误)

#### 10.1 问题背景

在修复 `530` 错误后，构建虽然能成功，但暴露出一个更深层次的性能问题：`next build` 在为所有文章、标签、分类等页面生成静态文件时，会重复调用数据获取函数 `getGlobalData` 上百次。这导致：
1.  **API 请求风暴**: 短时间内产生上百次对 Notion API 的请求，极易触发 `429 Too Many Requests` 速率限制错误，导致构建随机失败。
2.  **构建缓慢**: 大量的重复网络请求严重拖慢了网站的整体构建速度。
3.  **日志污染**: 构建日志中出现上百条 `lastmod-map.json updated` 的记录，增加了问题排查的难度。

#### 10.2 解决方案：构建时内存缓存

为了根治此问题，我们采用了**构建时内存缓存 (Build-time In-Memory Cache)** 策略。

- **核心思路**: 在单次 `next build` 命令的生命周期内，利用 Node.js 进程的内存共享特性，确保 Notion API 的数据只被真正请求一次，后续所有调用都从内存中快速读取。
- **实现方式**: 在 `lib/db/getSiteData.js` 的 `getGlobalData` 函数中，创建并使用了一个全局缓存变量 `global.__GLOBAL_DATA_CACHE__`。

#### 10.3 修改的文件

**lib/db/getSiteData.js**

修改 `getGlobalData` 函数，在函数入口处增加缓存检查逻辑。

```javascript
// lib/db/getSiteData.js

export async function getGlobalData({
  pageId = BLOG.NOTION_PAGE_ID,
  from,
  locale
}) {
  let data;
  // 检查构建时内存缓存
  if (global.__GLOBAL_DATA_CACHE__) {
    console.log('[Build Cache] Hit: Returning data from in-memory cache.');
    data = global.__GLOBAL_DATA_CACHE__;
  } else {
    // 如果缓存不存在，则执行完整的数据获取流程
    const siteIds = pageId?.split(',') || [];
    let fetchedData = EmptyData(pageId);

    // ... (原有的 for 循环和 try-catch 数据获取逻辑)

    data = fetchedData;
    // 将数据存入构建时内存缓存，供后续调用使用
    global.__GLOBAL_DATA_CACHE__ = data;
    console.log('[Build Cache] Miss: Fetched data and cached in memory.');
  }

  // 每次都返回深拷贝的数据，防止下游修改污染缓存
  return handleDataBeforeReturn(deepClone(data));
}
```

#### 10.4 实现效果

- **API 请求锐减**: 对 Notion API 的请求从 100+ 次降低到几次（取决于 Next.js 启动的构建工人进程数量，通常为 2-4 次），彻底解决了 `429` 错误。
- **构建稳定性**: 构建流程不再因 API 速率限制而随机失败，变得非常稳定。
- **构建速度提升**: 大量秒级的网络请求被微秒级的内存读取取代，网站构建速度得到显著提升。

### 11. Vercel 部署优化 (解决 Serverless Function 体积超限)

#### 11.1 问题背景

在构建过程中，我们会生成一些体积较大的缓存文件（如 `lastmod-map.json` 和 webpack 缓存）来提升性能和实现特定功能。然而，Vercel 在打包部署产物时，其依赖分析工具 (`outputFileTracing`) 会错误地将这些仅在构建时需要的缓存文件也一并打包进 Serverless Function 中，导致函数体积轻易超过 `250 MB` 的上限，从而引发部署失败。

#### 11.2 解决方案演进与最终方案

**第一版尝试：操作系统临时目录缓存 (`/tmp`) (失败)**
- **思路**: 将缓存文件写入 Vercel 不会打包的 `/tmp` 目录。
- **结果**: 此方案导致了 Sitemap 生成失败。因为在 Vercel 的构建环境中，`next build` 和后续的 `node scripts/merge-sitemap.js` 是在**相互隔离**的步骤中运行的，后一个步骤无法访问前一个步骤在 `/tmp` 中创建的文件。

**第二版尝试：项目内缓存 + `.vercelignore` (失败)**
- **思路**: 将缓存文件写入项目内部的持久化路径（如 `.next/cache`），然后使用 `.vercelignore` 文件告诉 Vercel 在打包时忽略此目录。
- **结果**: 此方案同样失败。因为 Vercel 的 `outputFileTracing` 依赖分析机制**优先级高于** `.vercelignore`。即使在 `.vercelignore` 中声明了忽略，依赖分析工具仍然会固执地将它认为是必需的文件而打包进去。

**第三版尝试（最终方案）：直接配置依赖分析工具**
- **思路**: 既然问题出在依赖分析工具的误判，就应该直接从源头配置该工具的行为。Next.js 提供了一个实验性但有效的配置 `outputFileTracingExcludes`，允许我们明确地告诉依赖分析工具“不要追踪这些文件或目录”。
- **最终方案**:
    1.  **统一缓存路径**: 将所有构建时缓存统一写入项目内的 `.next/cache/` 目录，确保构建步骤之间的数据可见性。
    2.  **修改 `next.config.js`**: 在 `next.config.js` 文件中，使用 `outputFileTracingExcludes` 配置来明确排除整个 `.next/cache` 目录。
    3.  **清理无效配置**: 移除之前创建但无效的 `.vercelignore` 文件。

#### 11.3 修改的文件

**1. next.config.js (修改)**

在 `next.config.js` 文件中添加 `experimental.outputFileTracingExcludes` 配置。

```javascript
// next.config.js

const { withContentlayer } = require('next-contentlayer')

/**
 * @type {import('next').NextConfig}
 */
const nextConfig = {
  // ... 其他配置
  experimental: {
    scrollRestoration: true,
    // 关键修复：告诉 Vercel 的依赖分析工具不要打包 .next/cache 目录
    outputFileTracingExcludes: {
      '**/.next/cache/**': ['**/.next/cache/**']
    }
  },
  // ... 其他配置
}

module.exports = withContentlayer(nextConfig)

```

**2. .vercelignore (已删除)**

此文件已被移除，因为 `outputFileTracingExcludes` 提供了更根本的解决方案。

#### 11.4 实现效果

- **Vercel 部署成功**: `250 MB` 体积超限的错误被彻底解决。
- **构建流程健壮**: Sitemap 生成流程所需的文件持久化得到保证。
- **直击要害**: 方案直接作用于问题根源（依赖分析），而不是在打包后期进行补救，配置更清晰，效果更稳定。

### 12. Sitemap 生成机制优化 (解决时间戳不准、重复路径等问题)

#### 12.1 问题背景

项目原有的 `sitemap.xml` 生成存在多个严重问题，影响SEO效果：
1.  **时间戳不准**: `next-sitemap` 库在构建过程中会截断文章的 `lastmod` 时间戳，导致其只精确到天，丢失了时分秒信息。
2.  **路径重复/错误**: 最终生成的 `sitemap.xml` 中包含重复的路径（如 `/about`）和格式完全错误的路径（如包含 `https://` 的 slug）。
3.  **外部路径合并不可靠**: `next-sitemap` 的 `additionalPaths` 功能不稳定。

#### 12.2 解决方案：三步流水线校准与合并

为了根治以上问题，我们设计并实施了一套全新的“三步流水线”Sitemap生成机制，完全绕开了 `next-sitemap` 的缺陷，确保了最终产物的准确性和健壮性。

- **核心思想**: 将 `next-sitemap` 的角色降级为单纯的“路径扫描器”，而使用我们自己的 Node.js 脚本 (`scripts/merge-sitemap.js`) 作为“最终校准与合并中心”，对数据进行最终裁决。

- **执行流程**:
  ```bash
  # 1. Next.js 正常构建，并在此过程中生成我们自己的可信时间戳缓存
  npx next build

  # 2. next-sitemap 扫描路径，生成一个包含错误时间的“草稿” sitemap.xml
  npx next-sitemap

  # 3. 运行我们自己的脚本，对“草稿”进行校准、合并、清洗，生成最终成品
  node scripts/merge-sitemap.js
  ```

#### 12.3 关键实现细节

**1. 生成可信的时间戳缓存 (`lastmod-map.json`)**
- **文件**: `lib/db/getSiteData.js`
- **逻辑**: 在 `next build` 过程中，当数据从 Notion 拉取后，会执行一个“读-合并-写”的操作，将所有页面的 `路径: 精确时间` 映射关系累积并写入到 `.next/cache/lastmod-map.json` 文件中。这个文件是后续所有时间校准的唯一“真相来源”。

**2. 最终校准、合并与清洗脚本**
- **文件**: `scripts/merge-sitemap.js`
- **逻辑 (四人流水线)**:
    1.  **工人A (档案员)**: 加载可信的 `lastmod-map.json`。
    2.  **工人B (检验员)**: 读取 `next-sitemap` 生成的草稿，**只提取路径**，丢弃所有错误数据（如错误的时间戳）。
    3.  **工人C (校准员)**: 使用“档案员”提供的时间，为“检验员”提取的每个路径校准 `lastmod` 时间。
    4.  **工人D (总装员/质检员)**:
        - 合并“校准员”处理过的内部路径和从 `sitemap-paths.txt` 获取的外部路径。
        - 对合并后的完整列表进行**最终质检**：
            - **去重**: 移除所有重复的 URL。
            - **清洗**: 移除所有格式不规范的 URL（如路径中包含 `://`）。
        - 生成最终的、干净、准确的 `sitemap.xml` 文件并覆盖旧文件。

#### 12.4 实现效果
- **时间戳精确**: 所有路径的 `lastmod` 都精确到秒。
- **内容完整无误**: 最终的 Sitemap 包含所有内外路径，且无重复、无格式错误。
- **流程健壮**: 整套机制不依赖 `next-sitemap` 的有缺陷功能，稳定可靠。

---

## 📝 版本记录

- **创建日期**: 2025年1月4日
- **更新日期**: 2025年10月11日
- **NotionNext版本**: 基于当前版本的自定义修改
- **主要功能**: 
  - 教育版页面、页脚链接配置、样式优化
  - GitHub Actions自动部署到阿里云服务器（2025年9月6日新增）
  - 规范链接(rel="canonical")实现（2025年9月7日新增）
  - 教育版页面优化：使用Notion页面自身的标题、摘要和封面图（2025年9月7日新增）
  - Cusdis评论系统集成（2025年9月9日新增）
  - Twikoo 评论系统集成（2025年9月12日新增）
  - Notion API 530 错误修复（2025年10月9日新增）
  - 构建时 API 请求优化（解决429错误）（2025年10月10日新增）
  - Vercel 部署优化（通过`outputFileTracingExcludes`解决体积超限）（2025年10月11日更新）
  - Sitemap 生成机制优化（解决时间戳、重复路径等问题）（2025年10月11日新增）

---

> 💡 **提示**: 建议将此文档与代码一起进行版本控制，确保修改记录的完整性。